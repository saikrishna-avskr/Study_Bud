<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pomodoro Timer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f7f8fa;
        color: #232946;
        margin: 0;
        min-height: 100vh;
        overflow-x: hidden;
        padding: 0;
      }
      .navbar {
        background: #fff !important;
        border-bottom: 2px solid #eebbc3;
        box-shadow: 0 2px 12px rgba(35, 41, 70, 0.04);
      }
      .navbar-brand {
        color: #ff6b6b !important;
        font-weight: 800;
        font-size: 1.6rem;
        letter-spacing: 1px;
      }
      .navbar-nav .nav-link {
        color: #232946 !important;
        font-weight: 700;
        letter-spacing: 0.5px;
        transition: color 0.2s;
      }
      .navbar-nav .nav-link:hover {
        color: #ff6b6b !important;
      }
      .pomodoro-container {
        max-width: 420px;
        margin: 40px auto 0 auto;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 18px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
        padding: 36px 28px 32px 28px;
        text-align: center;
        position: relative;
      }
      .timer-svg {
        width: 220px;
        height: 220px;
        display: block;
        margin: 0 auto 18px auto;
      }
      .timer-text {
        font-size: 3.2rem;
        font-weight: 700;
        color: #fff;
        letter-spacing: 2px;
        position: absolute;
        left: 0;
        right: 0;
        top: 90px;
        text-align: center;
        pointer-events: none;
      }
      .mode-label {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #fff;
        letter-spacing: 1px;
      }
      .session-count {
        color: #eebbc3;
        font-size: 1.1rem;
        margin-bottom: 18px;
        font-weight: 500;
      }
      .pomodoro-controls {
        display: flex;
        justify-content: center;
        gap: 18px;
        margin: 18px 0 0 0;
      }
      .pomodoro-btn {
        background: linear-gradient(145deg, #ff6b6b, #f7b7a3);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        padding: 10px 28px;
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.08);
        transition: all 0.2s;
        outline: none;
      }
      .pomodoro-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pomodoro-btn:not(:disabled):hover {
        filter: brightness(1.08);
        box-shadow: 0 4px 16px rgba(255, 107, 107, 0.18);
      }
      .settings-panel {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        margin: 24px 0 0 0;
        padding: 0 0 0 0;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(35, 41, 70, 0.08);
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s;
        max-height: 0;
        padding: 0 24px;
        opacity: 0;
        pointer-events: none;
      }
      .settings-panel.open {
        max-height: 320px;
        padding: 18px 24px 18px 24px;
        opacity: 1;
        pointer-events: auto;
      }
      .settings-toggle {
        background: none;
        border: none;
        color: #eebbc3;
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0 auto 0 0;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: color 0.2s;
        outline: none;
      }
      .settings-toggle .arrow {
        margin-left: 8px;
        transition: transform 0.3s;
        font-size: 1.3rem;
      }
      .settings-toggle.open .arrow {
        transform: rotate(90deg);
      }
      .settings-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .settings-row label {
        color: #fff;
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 0;
      }
      .settings-row input[type="number"] {
        width: 60px;
        border-radius: 6px;
        border: 1px solid #eebbc3;
        padding: 4px 8px;
        font-size: 1rem;
        background: #232946;
        color: #fff;
        margin-left: 10px;
      }
      .settings-row input[type="number"]::-webkit-inner-spin-button,
      .settings-row input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .settings-row input[type="number"]:focus {
        outline: 2px solid #eebbc3;
      }
      .settings-row .toggle-switch {
        position: relative;
        width: 48px;
        height: 24px;
        display: inline-block;
      }
      .settings-row .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .settings-row .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #eebbc3;
        border-radius: 24px;
        transition: background 0.3s;
      }
      .settings-row .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.3s;
        box-shadow: 0 2px 6px rgba(35, 41, 70, 0.12);
      }
      .settings-row .toggle-switch input:checked + .slider {
        background: #ff6b6b;
      }
      .settings-row .toggle-switch input:checked + .slider:before {
        transform: translateX(24px);
      }
      .stats-panel {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        margin: 24px 0 0 0;
        padding: 18px 24px;
        box-shadow: 0 2px 8px rgba(35, 41, 70, 0.08);
        color: #fff;
        font-size: 1.05rem;
        text-align: left;
      }
      .stats-panel strong {
        color: #eebbc3;
      }
      .notification-panel {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 9999;
        min-width: 220px;
        background: rgba(255, 255, 255, 0.98);
        color: #232946;
        border-radius: 10px;
        box-shadow: 0 4px 16px rgba(35, 41, 70, 0.18);
        padding: 18px 24px;
        font-size: 1.1rem;
        font-weight: 600;
        opacity: 0;
        pointer-events: none;
        transform: translateY(-30px);
        transition: opacity 0.4s, transform 0.4s;
      }
      .notification-panel.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }
      @media (max-width: 600px) {
        .pomodoro-container {
          padding: 18px 2vw 18px 2vw;
          max-width: 98vw;
        }
        .timer-svg {
          width: 160px;
          height: 160px;
        }
        .timer-text {
          font-size: 2.2rem;
          top: 60px;
        }
        .stats-panel,
        .settings-panel.open {
          padding: 12px 6vw;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg w-100">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">StudyBud</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/study_plan/">Study Planner</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/evaluate_assignment/"
                >Evaluate Assignment</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/generate_image">Generate Image</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/generate_code">Code Generator</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/annotate/">Describe Image</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pomodoro">Pomodoro Timer</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="pomodoro-container">
      <div class="mode-label" id="modeLabel">üçÖ Work</div>
      <div class="session-count" id="sessionCount">Session: 1</div>
      <div style="position: relative">
        <svg class="timer-svg" viewBox="0 0 220 220">
          <circle
            cx="110"
            cy="110"
            r="100"
            stroke="#eebbc3"
            stroke-width="10"
            fill="none"
            opacity="0.18"
          />
          <circle
            id="progressRing"
            cx="110"
            cy="110"
            r="100"
            stroke="#fff"
            stroke-width="10"
            fill="none"
            stroke-linecap="round"
            stroke-dasharray="628"
            stroke-dashoffset="0"
            style="transition: stroke 0.3s"
          />
        </svg>
        <div class="timer-text" id="timerText">25:00</div>
      </div>
      <div class="pomodoro-controls">
        <button class="pomodoro-btn" id="startBtn">Start</button>
        <button class="pomodoro-btn" id="pauseBtn" disabled>Pause</button>
        <button class="pomodoro-btn" id="resetBtn">Reset</button>
      </div>
      <button class="settings-toggle" id="settingsToggle">
        ‚öôÔ∏è Settings <span class="arrow">‚ñ∂</span>
      </button>
      <div class="settings-panel" id="settingsPanel">
        <div class="settings-row">
          <label for="workDuration">Work (min):</label>
          <input type="number" id="workDuration" min="1" max="90" />
        </div>
        <div class="settings-row">
          <label for="shortBreakDuration">Short Break (min):</label>
          <input type="number" id="shortBreakDuration" min="1" max="30" />
        </div>
        <div class="settings-row">
          <label for="longBreakDuration">Long Break (min):</label>
          <input type="number" id="longBreakDuration" min="1" max="60" />
        </div>
        <div class="settings-row">
          <label>Sound:</label>
          <label class="toggle-switch">
            <input type="checkbox" id="soundToggle" />
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="stats-panel" id="statsPanel">
        <div>
          <strong>Completed Sessions:</strong>
          <span id="completedSessions">0</span>
        </div>
        <div>
          <strong>Total Study Time:</strong>
          <span id="totalStudyTime">0h 0m</span>
        </div>
        <div>
          <strong>Today's Sessions:</strong> <span id="todaysSessions">0</span>
        </div>
      </div>
    </div>
    <div class="notification-panel" id="notificationPanel"></div>
    <br />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- Pomodoro Timer Logic ---
      // Modes
      const MODES = [
        { name: "Work", emoji: "üçÖ", color: "#fff" },
        { name: "Short Break", emoji: "‚òï", color: "#4be07a" },
        { name: "Long Break", emoji: "üå¥", color: "#4be07a" },
      ];
      let mode = 0; // 0: Work, 1: Short Break, 2: Long Break
      let session = 1;
      let timer = null;
      let timeLeft = 1500; // 25 min default
      let isRunning = false;
      let completedSessions = 0;
      let totalStudySeconds = 0;
      let todaysSessions = 0;
      let lastSessionDate = "";
      let autoReset = false;
      // Settings
      let workDuration = 25,
        shortBreakDuration = 5,
        longBreakDuration = 15;
      let soundOn = true;
      // DOM
      const timerText = document.getElementById("timerText");
      const progressRing = document.getElementById("progressRing");
      const modeLabel = document.getElementById("modeLabel");
      const sessionCount = document.getElementById("sessionCount");
      const startBtn = document.getElementById("startBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const resetBtn = document.getElementById("resetBtn");
      const settingsToggle = document.getElementById("settingsToggle");
      const settingsPanel = document.getElementById("settingsPanel");
      const workInput = document.getElementById("workDuration");
      const shortBreakInput = document.getElementById("shortBreakDuration");
      const longBreakInput = document.getElementById("longBreakDuration");
      const soundToggle = document.getElementById("soundToggle");
      const completedSessionsEl = document.getElementById("completedSessions");
      const totalStudyTimeEl = document.getElementById("totalStudyTime");
      const todaysSessionsEl = document.getElementById("todaysSessions");
      const notificationPanel = document.getElementById("notificationPanel");

      // --- LocalStorage Helpers ---
      function saveStats() {
        const today = new Date().toISOString().slice(0, 10);
        localStorage.setItem(
          "pomodoro_stats",
          JSON.stringify({
            completedSessions,
            totalStudySeconds,
            todaysSessions,
            lastSessionDate: today,
          })
        );
      }
      function loadStats() {
        const stats = JSON.parse(
          localStorage.getItem("pomodoro_stats") || "{}"
        );
        completedSessions = stats.completedSessions || 0;
        totalStudySeconds = stats.totalStudySeconds || 0;
        todaysSessions = stats.todaysSessions || 0;
        lastSessionDate = stats.lastSessionDate || "";
        // Reset today's sessions if date changed
        const today = new Date().toISOString().slice(0, 10);
        if (lastSessionDate !== today) {
          todaysSessions = 0;
          lastSessionDate = today;
          saveStats();
        }
      }
      function saveSettings() {
        localStorage.setItem(
          "pomodoro_settings",
          JSON.stringify({
            workDuration,
            shortBreakDuration,
            longBreakDuration,
            soundOn,
          })
        );
      }
      function loadSettings() {
        const s = JSON.parse(localStorage.getItem("pomodoro_settings") || "{}");
        workDuration = s.workDuration || 25;
        shortBreakDuration = s.shortBreakDuration || 5;
        longBreakDuration = s.longBreakDuration || 15;
        soundOn = s.soundOn !== undefined ? s.soundOn : true;
      }

      // --- UI Update Functions ---
      function updateTimerUI() {
        const min = Math.floor(timeLeft / 60)
          .toString()
          .padStart(2, "0");
        const sec = (timeLeft % 60).toString().padStart(2, "0");
        timerText.textContent = `${min}:${sec}`;
        // Progress ring
        let total = 0;
        if (mode === 0) total = workDuration * 60;
        else if (mode === 1) total = shortBreakDuration * 60;
        else total = longBreakDuration * 60;
        const percent = 1 - timeLeft / total;
        const offset = 628 * (1 - percent);
        progressRing.setAttribute("stroke", MODES[mode].color);
        progressRing.setAttribute("stroke-dashoffset", offset);
      }
      function updateModeUI() {
        modeLabel.textContent = `${MODES[mode].emoji} ${MODES[mode].name}`;
        progressRing.setAttribute("stroke", MODES[mode].color);
      }
      function updateSessionUI() {
        sessionCount.textContent = `Session: ${session}`;
      }
      function updateStatsUI() {
        completedSessionsEl.textContent = completedSessions;
        const h = Math.floor(totalStudySeconds / 3600);
        const m = Math.floor((totalStudySeconds % 3600) / 60);
        totalStudyTimeEl.textContent = `${h}h ${m}m`;
        todaysSessionsEl.textContent = todaysSessions;
      }

      // --- Timer Logic ---
      function startTimer() {
        if (isRunning) return;
        isRunning = true;
        startBtn.disabled = true;
        pauseBtn.disabled = false;
        resetBtn.disabled = false;
        timer = setInterval(() => {
          if (timeLeft > 0) {
            timeLeft--;
            updateTimerUI();
          } else {
            clearInterval(timer);
            isRunning = false;
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            resetBtn.disabled = false;
            // Session complete
            if (mode === 0) {
              // Work
              completedSessions++;
              totalStudySeconds += workDuration * 60;
              todaysSessions++;
              saveStats();
              showNotification("Work session complete! Time for a break.");
              if (soundOn) playAlarm();
              // Switch to break
              if (session % 4 === 0) {
                mode = 2; // Long break
              } else {
                mode = 1; // Short break
              }
            } else {
              showNotification("Break finished! Back to work.");
              if (soundOn) playAlarm();
              mode = 0;
              session++;
            }
            setMode(mode);
          }
        }, 1000);
      }
      function pauseTimer() {
        if (!isRunning) return;
        isRunning = false;
        clearInterval(timer);
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        resetBtn.disabled = false;
      }
      function resetTimer() {
        clearInterval(timer);
        isRunning = false;
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        resetBtn.disabled = false;
        setMode(mode, true);
      }
      function setMode(newMode, resetSession = false) {
        mode = newMode;
        if (mode === 0) timeLeft = workDuration * 60;
        else if (mode === 1) timeLeft = shortBreakDuration * 60;
        else timeLeft = longBreakDuration * 60;
        if (resetSession) {
          if (mode === 0) session = 1;
        }
        updateModeUI();
        updateTimerUI();
        updateSessionUI();
        updateStatsUI();
      }

      // --- Settings Panel ---
      function updateSettingsUI() {
        workInput.value = workDuration;
        shortBreakInput.value = shortBreakDuration;
        longBreakInput.value = longBreakDuration;
        soundToggle.checked = !!soundOn;
      }

      settingsToggle.addEventListener("click", () => {
        settingsPanel.classList.toggle("open");
        settingsToggle.classList.toggle("open");
        updateSettingsUI();
      });

      // Ensure settings UI is always in sync after loading
      updateSettingsUI();

      workInput.addEventListener("change", () => {
        workDuration = Math.max(
          1,
          Math.min(90, parseInt(workInput.value) || 25)
        );
        saveSettings();
        updateSettingsUI();
        if (mode === 0) setMode(0);
      });
      shortBreakInput.addEventListener("change", () => {
        shortBreakDuration = Math.max(
          1,
          Math.min(30, parseInt(shortBreakInput.value) || 5)
        );
        saveSettings();
        updateSettingsUI();
        if (mode === 1) setMode(1);
      });
      longBreakInput.addEventListener("change", () => {
        longBreakDuration = Math.max(
          1,
          Math.min(60, parseInt(longBreakInput.value) || 15)
        );
        saveSettings();
        updateSettingsUI();
        if (mode === 2) setMode(2);
      });
      soundToggle.addEventListener("change", () => {
        soundOn = soundToggle.checked;
        saveSettings();
        updateSettingsUI();
      });

      // --- Controls ---
      startBtn.addEventListener("click", startTimer);
      pauseBtn.addEventListener("click", pauseTimer);
      resetBtn.addEventListener("click", resetTimer);

      // --- Keyboard Shortcuts ---
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          if (isRunning) pauseTimer();
          else startTimer();
        } else if (e.ctrlKey && (e.key === "r" || e.key === "R")) {
          e.preventDefault();
          resetTimer();
        }
      });

      // --- Sound ---
      // Use mp3 alarm sound from static, fallback to Web Audio beep
      let audioCtx = null;
      let alarmAudio = null;
      function playAlarm() {
        if (!alarmAudio) {
          alarmAudio = new Audio("/static/winner-bell-game-show-91932.mp3");
          alarmAudio.preload = "auto";
        }
        alarmAudio.currentTime = 0;
        alarmAudio.volume = 0.7;
        const playPromise = alarmAudio.play();
        if (playPromise && playPromise.catch) {
          playPromise.catch(() => beep());
        }
      }
      function beep() {
        try {
          if (!audioCtx || audioCtx.state === "closed") {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          // Alarm: triangle wave, frequency sweep, short duration
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "triangle";
          o.frequency.setValueAtTime(1200, audioCtx.currentTime);
          o.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.18);
          o.frequency.linearRampToValueAtTime(
            1400,
            audioCtx.currentTime + 0.36
          );
          g.gain.setValueAtTime(0.18, audioCtx.currentTime);
          g.gain.linearRampToValueAtTime(0.0, audioCtx.currentTime + 0.38);
          o.connect(g);
          g.connect(audioCtx.destination);
          o.start();
          setTimeout(() => {
            o.stop();
            o.disconnect();
            g.disconnect();
          }, 400);
        } catch (e) {
          if (audioCtx && audioCtx.state !== "running") {
            audioCtx.resume && audioCtx.resume();
          }
        }
      }

      // Unlock AudioContext on first user gesture
      document.addEventListener("click", function unlockAudio() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state !== "running") {
          audioCtx.resume && audioCtx.resume();
        }
        document.removeEventListener("click", unlockAudio);
      });

      // --- Notification ---
      function showNotification(msg) {
        notificationPanel.textContent = msg;
        notificationPanel.classList.add("show");
        setTimeout(() => notificationPanel.classList.remove("show"), 3500);
      }

      // --- Init ---
      loadSettings();
      loadStats();
      setMode(0, true);
      updateStatsUI();
      pauseBtn.disabled = true;
      resetBtn.disabled = false;
    </script>
  </body>
</html>
